#!/bin/bash
set -e

THEME_NAME="$1"
BASE16_DIR="$HOME/.config/base16"
THEME_FILE="$BASE16_DIR/$THEME_NAME.yaml"
CACHE_DIR="$HOME/.cache/theme"
SCRIPT_DIR="$(dirname "$(realpath "$0")")"

[[ -z "$THEME_NAME" ]] && echo "Usage: theme-set <theme-name>" && exit 1
[[ ! -f "$THEME_FILE" ]] && echo "Theme not found: $THEME_NAME" && exit 1

mkdir -p "$CACHE_DIR"

get_color() { yq ".palette.$1" "$THEME_FILE" | tr -d '"'; }

export base00=$(get_color base00)
export base01=$(get_color base01)
export base02=$(get_color base02)
export base03=$(get_color base03)
export base04=$(get_color base04)
export base05=$(get_color base05)
export base06=$(get_color base06)
export base07=$(get_color base07)
export base08=$(get_color base08)
export base09=$(get_color base09)
export base0A=$(get_color base0A)
export base0B=$(get_color base0B)
export base0C=$(get_color base0C)
export base0D=$(get_color base0D)
export base0E=$(get_color base0E)
export base0F=$(get_color base0F)

export CACHE_DIR THEME_NAME

echo "$THEME_NAME" > "$CACHE_DIR/current"

for module in "$SCRIPT_DIR/theme-set.d"/*.sh; do
    [[ -f "$module" ]] && source "$module"
done

echo "Theme set to: $THEME_NAME"

# Notify user about apps that need restart
notify-send "Theme: $THEME_NAME" "Restart Zen, GTK, and Qt apps to apply" -i preferences-desktop-theme 2>/dev/null || true
