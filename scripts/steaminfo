#!/usr/bin/env bash

set -euo pipefail

readonly C_RESET='\033[0m'
readonly C_BOLD='\033[1m'
readonly C_CYAN='\033[36m'
readonly C_YELLOW='\033[33m'
readonly C_GREEN='\033[32m'

declare -A proton_games

get_proton_games() {
    while read -r line; do
        local appid name
        appid=$(echo "$line" | cut -d ' ' -f 1)
        name=$(echo "$line" | cut -d ' ' -f 2-)
        proton_games["$appid"]="$name"
    done < <(protontricks -l 2>/dev/null | awk '/\([0-9]+\)/ { match($0, /\(([0-9]+)\)/, arr); appid = arr[1]; gsub(/ *\([^)]+\) */, "", $0); print appid " " $0 }')
}

find_steam_libraries() {
    local vdf_file=""
    for location in "$HOME/.local/share/Steam/steamapps/libraryfolders.vdf" "$HOME/.steam/steam/steamapps/libraryfolders.vdf"; do
        [[ -f "$location" ]] && vdf_file="$location" && break
    done

    if [[ -z "$vdf_file" ]]; then
        echo "Error: Could not find libraryfolders.vdf" >&2
        return 1
    fi

    grep -oP '"path"\s+"\K[^"]+' "$vdf_file" | while read -r path; do
        [[ -d "${path}/steamapps" ]] && echo "${path}/steamapps"
    done
}

main() {
    echo "Scanning Steam libraries..."

    get_proton_games

    local -a steam_libraries
    while IFS= read -r library; do
        steam_libraries+=("$library")
    done < <(find_steam_libraries)

    if [[ ${#steam_libraries[@]} -eq 0 ]]; then
        echo "Error: No Steam libraries found" >&2
        exit 1
    fi

    echo "Found ${#steam_libraries[@]} Steam library location(s)"
    echo ""

    local -a proton_names proton_install proton_compat
    local -a native_names native_install

    for steamapps in "${steam_libraries[@]}"; do
        for manifest in "$steamapps"/appmanifest_*.acf; do
            [[ -f "$manifest" ]] || continue

            local appid="${manifest##*appmanifest_}"
            appid="${appid%.acf}"

            local installdir
            installdir=$(grep -oP '"installdir"\s+"\K[^"]+' "$manifest" 2>/dev/null) || continue

            local install_path="${steamapps}/common/${installdir}"

            if [[ -v proton_games["$appid"] ]]; then
                proton_names+=("${proton_games[$appid]}")
                proton_install+=("$install_path")
                proton_compat+=("${steamapps}/compatdata/${appid}/pfx")
            else
                local name
                name=$(grep -oP '"name"\s+"\K[^"]+' "$manifest" 2>/dev/null) || continue
                [[ "$name" =~ ^(Proton|Steam\ Linux\ Runtime|Steamworks) ]] && continue
                native_names+=("$name")
                native_install+=("$install_path")
            fi
        done
    done

    if [[ ${#native_names[@]} -gt 0 ]]; then
        echo -e "${C_BOLD}Native Linux Games (${#native_names[@]})${C_RESET}"
        echo ""
        {
            printf "${C_BOLD}Game Name${C_RESET}\t${C_BOLD}Install Path${C_RESET}\n"
            for i in "${!native_names[@]}"; do
                printf "${C_CYAN}%s${C_RESET}\t${C_YELLOW}%s${C_RESET}\n" "${native_names[$i]}" "${native_install[$i]}"
            done
        } | sort -t$'\t' -k1 | column -t -s $'\t' -o ' │ '
        echo ""
    fi

    if [[ ${#proton_names[@]} -gt 0 ]]; then
        echo -e "${C_BOLD}Proton Games (${#proton_names[@]})${C_RESET}"
        echo ""
        {
            printf "${C_BOLD}Game Name${C_RESET}\t${C_BOLD}Install Path${C_RESET}\t${C_BOLD}Compatdata Path${C_RESET}\n"
            for i in "${!proton_names[@]}"; do
                printf "${C_CYAN}%s${C_RESET}\t${C_YELLOW}%s${C_RESET}\t${C_GREEN}%s${C_RESET}\n" "${proton_names[$i]}" "${proton_install[$i]}" "${proton_compat[$i]}"
            done
        } | sort -t$'\t' -k1 | column -t -s $'\t' -o ' │ '
        echo ""
    fi

    echo "Total: ${#native_names[@]} native + ${#proton_names[@]} proton = $((${#native_names[@]} + ${#proton_names[@]})) games"
}

main "$@"
